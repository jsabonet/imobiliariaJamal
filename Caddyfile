# Caddy Configuration - IJPS Imobiliária
# Proxy reverso com HTTPS automático via Let's Encrypt

imobiliariajamal.com, www.imobiliariajamal.com {
	# Redireciona www para domínio principal
	@www host www.imobiliariajamal.com
	redir @www https://imobiliariajamal.com{uri} permanent

	# Gzip compression
	encode gzip

	# Backend API (sem remover prefixo /api)
	@api path /api*
	reverse_proxy @api backend:8000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
		header_up Host {host}
	}

	# Media files (uploads) - servir diretamente do filesystem
	handle /media/* {
		root * /app
		file_server
	}

	# Static files
	@static path /static*
	reverse_proxy @static backend:8000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
		header_up Host {host}
	}

	# Frontend (Next.js) - restante tráfego
	reverse_proxy frontend:3000

	# Logs
	log {
		output file /var/log/caddy/access.log
	}
}

# Fallback para acesso por IP (sem hostname), útil para testes
:80 {
	encode gzip

	# API
	@api path /api*
	reverse_proxy @api backend:8000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
		header_up Host {host}
	}

	# Frontend
	reverse_proxy frontend:3000
}

# HTTPS por IP com certificado interno (não será confiável pelo browser)
:443 {
	tls internal
	encode gzip

	# API
	@api path /api*
	reverse_proxy @api backend:8000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
		header_up Host {host}
	}

	# Admin
	@admin path /admin*
	reverse_proxy @admin backend:8000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
		header_up Host {host}
	}

	# Frontend
	reverse_proxy frontend:3000
}
